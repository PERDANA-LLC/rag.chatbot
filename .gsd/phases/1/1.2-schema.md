---
phase: 1
plan: 2
wave: 2
depends_on: [1]
files_modified:
  - supabase/schema.sql
  - types/supabase.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Apply database schema"
    dashboard_config:
      - task: "Run SQL Query"
        location: "Supabase Dashboard -> SQL Editor -> New Query -> Paste schema.sql content -> Run"

must_haves:
  truths:
    - "Detailed multi-tenancy schema is defined"
    - "RLS policies enforce isolation"
  artifacts:
    - "supabase/schema.sql exists"
    - "types/supabase.ts exists"
---

# Plan 1.2: Database Schema & Types

<objective>
Define the Supabase Database schema for multi-tenancy (Organizations, Chatbots, Users). Create SQL migration file and TypeScript definitions.

Purpose: specific instructions to ensure data isolation.
Output: specific instructions to SQL file and Type definitions.
</objective>

<context>
Load for context:
- .gsd/SPEC.md
- .gsd/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Create Schema SQL</name>
  <files>supabase/schema.sql</files>
  <action>
    Create a SQL file defining:
    1. `organizations` table (id, name, created_at).
    2. `profiles` table (id references auth.users, org_id references organizations).
    3. `chatbots` table (id, org_id, name, config jsonb).
    4. RLS Policies:
       - Users can only read/update their own profile.
       - Users can only read/write chatbots belonging to their `org_id`.
  </action>
  <verify>cat supabase/schema.sql</verify>
  <done>SQL file contains tables and RLS policies</done>
</task>

<task type="auto">
  <name>Generate Types</name>
  <files>types/supabase.ts</files>
  <action>
    Create a TypeScript file exporting `Database` interface matching the SQL schema manually (since we might not have CLI access).
    Include tables: profiles, organizations, chatbots.
  </action>
  <verify>cat types/supabase.ts</verify>
  <done>Types correctly mapped to schema</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Schema handles multi-tenancy (org_id linkage)
- [ ] Types match the schema
</verification>
