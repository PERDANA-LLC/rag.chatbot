---
phase: 2
plan: 3
wave: 2
depends_on: [1, 2]
files_modified:
  - app/api/knowledge/upload/route.ts
  - app/api/knowledge/crawl/route.ts
  - types/supabase.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API endpoints receive files/URLs"
    - "Data flows to Gemini/Firecrawl"
    - "Metadata stored in Supabase"
  artifacts:
    - "app/api/knowledge/upload/route.ts exists"
    - "app/api/knowledge/crawl/route.ts exists"
---

# Plan 2.3: Ingestion API

<objective>
Create Next.js API Routes to handle knowledge ingestion.
1. `/api/knowledge/upload`: Accepts FormData (PDF/TXT), uploads to Gemini, stores metadata in `knowledge_base_sources` (need to create this table first!).
2. `/api/knowledge/crawl`: Accepts URL, triggers Firecrawl, uploads results to Gemini, stores metadata.

**Note**: We missed `knowledge_base_sources` in Phase 1 Schema. Will add it here.

Purpose: specific instructions to glue Frontend to AI Services.
Output: specific instructions to working API endpoints.
</objective>

<context>
Load for context:
- .gsd/SPEC.md
- lib/ai/gemini.ts
- lib/ai/firecrawl.ts
</context>

<tasks>

<task type="auto">
  <name>Update Schema for Sources</name>
  <files>supabase/migrations/0001_sources.sql, types/supabase.ts</files>
  <action>
    Create new SQL migration:
    - `knowledge_base_sources` table: id, chatbot_id, type (file/url), content_uri (gemini uri), source_url (original name/url), status.
    - RLS policies.
    - Update TypeScript definitions.
  </action>
  <verify>ls supabase/migrations</verify>
  <done>Schema updated for API usage</done>
</task>

<task type="auto">
  <name>Create Upload Endpoint</name>
  <files>app/api/knowledge/upload/route.ts</files>
  <action>
    POST endpoint:
    - Check Auth.
    - Parse FormData -> File.
    - Call `GeminiService.uploadFile`.
    - Insert row into `knowledge_base_sources`.
    - Return success.
  </action>
  <verify>ls app/api/knowledge/upload/route.ts</verify>
  <done>Upload API ready</done>
</task>

<task type="auto">
  <name>Create Crawl Endpoint</name>
  <files>app/api/knowledge/crawl/route.ts</files>
  <action>
    POST endpoint:
    - Check Auth.
    - Parse JSON -> URL.
    - Call `FirecrawlService.crawlWebsite`.
    - Loop results: Save as temp files -> Upload to Gemini -> Clean temp.
    - Insert rows into `knowledge_base_sources`.
    - Return success.
  </action>
  <verify>ls app/api/knowledge/crawl/route.ts</verify>
  <done>Crawl API ready</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] SQL migration applied manually
- [ ] APIs build
</verification>
