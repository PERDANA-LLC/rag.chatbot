---
phase: 5
plan: 2
wave: 1
depends_on: [1]
files_modified:
  - app/dashboard/settings/page.tsx
  - components/subscription-card.tsx
  - app/api/stripe/portal/route.ts
  - app/dashboard/layout.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can view current plan and usage"
    - "User can upgrade to Pro"
    - "User can manage existing subscription (Portal)"
  artifacts:
    - "components/subscription-card.tsx exists"
---

# Plan 5.2: Subscription UI

<objective>
Allow users to Subscribe and Manage Subscriptions from the Dashboard.
1. Backend: Portal Route.
2. UI: Subscription Settings Page (or Card).
3. Integration: Connect buttons to Checkout and Portal routes.

Purpose: specific instructions to frontend billing.
Output: specific instructions to user-facing subscription management.
</objective>

<context>
Load for context:
- .gsd/SPEC.md
- app/api/stripe/checkout/route.ts
</context>

<tasks>

<task type="auto">
  <name>Stripe Customer Portal</name>
  <files>app/api/stripe/portal/route.ts</files>
  <action>
    - `POST /api/stripe/portal`:
    - Get user/org.
    - `stripe.billingPortal.sessions.create({ customer: org.stripe_customer_id })`.
    - Return URL.
  </action>
  <verify>ls app/api/stripe/portal/route.ts</verify>
  <done>Portal route created</done>
</task>

<task type="auto">
  <name>Subscription Component</name>
  <files>components/subscription-card.tsx</files>
  <action>
    - `SubscriptionCard({ org })`:
      - Display Plan: {org.subscription_status}
      - Display Usage: {org.messages_count} / {limit}
      - Actions:
        - If Free:
          - "Upgrade to Pro" button -> calls `/api/stripe/checkout` with Pro Price ID (hardcoded or prop).
        - If Active:
          - "Manage Subscription" button -> calls `/api/stripe/portal`.
  </action>
  <verify>ls components/subscription-card.tsx</verify>
  <done>Subscription Card component created</done>
</task>

<task type="auto">
  <name>Settings Page Update</name>
  <files>app/dashboard/settings/page.tsx</files>
  <action>
    - Add `SubscriptionCard` to the Settings page (create if not exists).
    - Fetch org data server-side and pass to card.
    - Note: Need a Price ID for "Pro". We'll define a constant or env var `NEXT_PUBLIC_PRO_PRICE_ID`.
  </action>
  <verify>ls app/dashboard/settings/page.tsx</verify>
  <done>Settings page updated</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Upgrade button redirects to Stripe Checkout
- [ ] Manage button redirects to Stripe Portal
- [ ] Usage bars show correct data
</verification>
