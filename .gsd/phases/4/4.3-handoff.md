---
phase: 4
plan: 3
wave: 2
depends_on: [1]
files_modified:
  - app/api/chat/route.ts
  - components/chat-interface.tsx
  - app/embed/[chatbotId]/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API respects handoff state (no AI reply if active)"
    - "Widget shows Agent status"
    - "User can request agent"
  artifacts:
    - "app/api/chat/route.ts modified"
---

# Plan 4.3: Handoff Logic Integration

<objective>
Connect the dots:
1. Widget allows asking for human.
2. API stops RAG when human is assigned.
3. Widget supports Realtime updates (visitor side).

Purpose: specific instructions to system logic.
Output: specific instructions to complete handoff flow.
</objective>

<context>
Load for context:
- .gsd/SPEC.md
</context>

<tasks>

<task type="auto">
  <name>Update Chat API</name>
  <files>app/api/chat/route.ts</files>
  <action>
    Modify POST /api/chat:
    - Fetch conversation.
    - IF status is 'active' or 'waiting':
      - Store user message.
      - DO NOT call RAG.
      - Return { message: null } (or status indicator).
    - ELSE (status='ai'):
      - Call RAG.
      - Return answer.
  </action>
  <verify>grep "status" app/api/chat/route.ts</verify>
  <done>API logic updated</done>
</task>

<task type="auto">
  <name>Update Widget for Realtime</name>
  <files>components/chat-interface.tsx</files>
  <action>
    - Integrate `useRealtimeChat` (or similar subscription) into the Widget.
    - Currently Widget uses `fetch`. It needs to ALSO subscribe to `messages` to receive Agent replies.
    - Logic:
      - On load: Fetch history + Subscribe to `messages`.
      - On send: Optimistic update + Fetch POST.
      - On receive (Realtime): Add to list (if ID not present).
    - Add "Request Agent" button in header. calls API/Action to set status='waiting'.
  </action>
  <verify>grep "subscribe" components/chat-interface.tsx</verify>
  <done>Widget is realtime aware</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] User sends message in 'active' mode -> No AI reply
- [ ] Agent sends message -> User sees it instantly
</verification>
