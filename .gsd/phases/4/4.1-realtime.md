---
phase: 4
plan: 1
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0003_realtime.sql
  - types/supabase.ts
  - hooks/use-realtime-chat.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Schema: conversations status (ai, waiting, agent, closed)"
    - "Schema: assigned_to (profile_id)"
    - "Realtime replication enabled for messages"
  artifacts:
    - "supabase/migrations/0003_realtime.sql exists"
---

# Plan 4.1: Realtime Infrastructure & Schema

<objective>
Prepare the database and client hooks for realtime human-to-human chat.
1. Update Schema: Add Hand-off states.
2. Enable Realtime in Supabase.
3. Create React Hook to subscribe to messages.

Purpose: specific instructions to infrastructure.
Output: specific instructions to schema and hooks.
</objective>

<context>
Load for context:
- .gsd/SPEC.md
</context>

<tasks>

<task type="auto">
  <name>Schema Updates</name>
  <files>supabase/migrations/0003_realtime.sql, types/supabase.ts</files>
  <action>
    Create migration:
    - Alter `conversations`:
      - Add `status` enum ('ai', 'waiting', 'active', 'closed') default 'ai'.
      - Add `assigned_to` uuid references profiles(id).
      - Add `unread_count` (integer)? Or calculate dynamically.
    - Enable Realtime:
      - `alter publication supabase_realtime add table messages;`
      - `alter publication supabase_realtime add table conversations;`
    
    Update TypeScript types.
  </action>
  <verify>ls supabase/migrations/0003_realtime.sql</verify>
  <done>Schema migration ready</done>
</task>

<task type="auto">
  <name>Realtime Hook</name>
  <files>hooks/use-realtime-chat.ts</files>
  <action>
    Create custom hook `useRealtimeChat(conversationId)`:
    - Subscribes to `messages` where `conversation_id=ID`.
    - Returns `messages` array, `sendMessage` function.
    - Handles `INSERT` events to push new message to state.
  </action>
  <verify>ls hooks/use-realtime-chat.ts</verify>
  <done>Realtime hook created</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] SQL migration applied
</verification>
